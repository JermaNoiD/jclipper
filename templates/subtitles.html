<!-- templates/subtitles.html -->
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .disabled {
            background-color: #555; /* Dark grey for disabled items */
            color: #bbb; /* Lighter text for contrast */
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
            <h1 class="header-title">Clipper</h1>
        </div>
        <h2 class="header-subheading">Subtitles</h2>
    </header>
    <div class="search-bar">
        <div>
            <button class="button" onclick="navigatePrevious()"> < </button>
            <button class="button" onclick="navigateNext()"> > </button>
            <button class="button" onclick="clearSelections()">Clear</button>
        </div>
        <input type="text" id="searchInput" class="search-input" placeholder="Search subtitles..." onkeyup="handleSearchKey(event)">
        <form action="/output" method="POST" style="margin: 0;">
            <input type="hidden" name="start" id="startInput" value="">
            <input type="hidden" name="end" id="endInput" value="">
            <button class="button" type="submit">Proceed</button>
        </form>
    </div>
    <div class="container">
        <div class="content">
            {% for sub in subs %}
                <div class="subtitle-item" onclick="selectSubtitle('{{ loop.index0 }}')" data-original-content="{{ sub.content }}" data-start-time="{{ sub.start_str }}">
                    <strong>{{ sub.start_str }} --> {{ sub.end_str }}</strong><br>
                    <div class="subtitle-content">{{ sub.content }}</div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        let startIndex = -1;
        let endIndex = -1;
        let currentHighlightIndex = -1;
        const items = document.getElementsByClassName('subtitle-item');

        function handleSearchKey(event) {
            if (event.key === 'Enter') {
                navigateToFirstResult();
            } else {
                highlightSubtitles();
            }
        }

        function navigateToFirstResult() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm || items.length === 0) return;

            let firstIndex = -1;
            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    firstIndex = i;
                    break;
                }
            }

            if (firstIndex !== -1) {
                currentHighlightIndex = firstIndex;
                items[currentHighlightIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlightSubtitles();
            }
        }

        function highlightSubtitles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            for (let i = 0; i < items.length; i++) {
                const contentDiv = items[i].getElementsByClassName('subtitle-content')[0];
                let content = items[i].dataset.originalContent;
                if (searchTerm) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    content = content.replace(regex, '<span class="highlight">$1</span>');
                }
                contentDiv.innerHTML = content;
                if (i === startIndex) contentDiv.innerHTML += '<span class="start-marker">&lt; Start</span>';
                if (i === endIndex) contentDiv.innerHTML += '<span class="end-marker">&lt; End</span>';
                items[i].classList.remove('disabled'); // Reset disabled state
                items[i].style.backgroundColor = '';
                if (i === startIndex) items[i].style.backgroundColor = '#4caf50';
                if (i === endIndex) items[i].style.backgroundColor = 'lightcoral';
                if (i === currentHighlightIndex) items[i].style.backgroundColor = '#ffffe0';
                items[i].style.display = 'block';
            }
            // Darken and disable items before startIndex
            if (startIndex !== -1) {
                const startTime = items[startIndex].dataset.startTime;
                for (let i = 0; i < startIndex; i++) {
                    const itemTime = items[i].dataset.startTime;
                    if (compareTimes(itemTime, startTime) < 0) {
                        items[i].classList.add('disabled');
                        items[i].style.pointerEvents = 'none'; // Disable clicking
                    }
                }
            }
        }

        function selectSubtitle(index) {
            const item = items[parseInt(index)];
            const itemTime = item.dataset.startTime;
            if (startIndex === -1) {
                startIndex = parseInt(index);
                document.getElementById('startInput').value = item.getElementsByTagName('strong')[0].textContent.split(' --> ')[0];
            } else if (endIndex === -1) {
                const startTime = items[startIndex].dataset.startTime;
                if (compareTimes(itemTime, startTime) >= 0) {
                    endIndex = parseInt(index);
                    document.getElementById('endInput').value = item.getElementsByTagName('strong')[0].textContent.split(' --> ')[1];
                } else {
                    alert("End time cannot be earlier than start time. Please select a later timestamp.");
                    return; // Prevent invalid selection
                }
            }
            highlightSubtitles();
        }

        function clearSelections() {
            startIndex = -1;
            endIndex = -1;
            document.getElementById('startInput').value = '';
            document.getElementById('endInput').value = '';
            highlightSubtitles();
        }

        function navigatePrevious() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm || items.length === 0) return;

            let newIndex = currentHighlightIndex - 1;
            if (newIndex < 0) newIndex = items.length - 1;

            while (newIndex !== currentHighlightIndex) {
                const text = items[newIndex].textContent.toLowerCase();
                if (text.includes(searchTerm)) break;
                newIndex = (newIndex - 1 + items.length) % items.length;
            }

            if (newIndex !== currentHighlightIndex) {
                currentHighlightIndex = newIndex;
                items[currentHighlightIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlightSubtitles();
            }
        }

        function navigateNext() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm || items.length === 0) return;

            let newIndex = currentHighlightIndex + 1;
            if (newIndex >= items.length) newIndex = 0;

            while (newIndex !== currentHighlightIndex) {
                const text = items[newIndex].textContent.toLowerCase();
                if (text.includes(searchTerm)) break;
                newIndex = (newIndex + 1) % items.length;
            }

            if (newIndex !== currentHighlightIndex) {
                currentHighlightIndex = newIndex;
                items[currentHighlightIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlightSubtitles();
            }
        }

        // Simple time comparison function (assumes HH:MM:SS,SSS format)
        function compareTimes(time1, time2) {
            const [h1, m1, s1] = time1.split(':').map(t => parseFloat(t.replace(',', '.')));
            const [h2, m2, s2] = time2.split(':').map(t => parseFloat(t.replace(',', '.')));
            const totalSeconds1 = h1 * 3600 + m1 * 60 + s1;
            const totalSeconds2 = h2 * 3600 + m2 * 60 + s2;
            return totalSeconds1 - totalSeconds2;
        }
    </script>
</body>
</html>
