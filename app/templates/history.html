{% extends 'base.html' %}
{% block title %}Jclipper - History{% endblock %}
{% block content %}
<nav class="bg-gray-100 py-4 dark:bg-gray-900">
    <div class="container mx-auto px-4">
        <div class="flex justify-center">
            <input type="text" id="searchInput" class="w-full max-w-2xl bg-white text-gray-900 text-center italic text-lg rounded-lg py-3 px-4 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700 dark:focus:ring-gray-500 placeholder-gray-500 dark:placeholder-gray-400 transition-colors" placeholder="Search history..." onkeyup="filterHistory()">
        </div>
    </div>
</nav>
<div class="container mx-auto mt-8 px-4 flex-grow">
    <div class="bg-white rounded-lg border border-gray-300 p-4 max-w-3xl mx-auto min-h-[200px] max-h-[60vh] overflow-y-auto no-scrollbar dark:bg-gray-800 dark:border-gray-700">
        {% if file_data %}
            <ul class="space-y-2">
                {% for full_path, basename in file_data %}
                    {% set base_no_ext = basename | splitext | first %}
                    {% set parts = base_no_ext | split('_') %}
                    {% set to_index = namespace(value=-1) %}
                    {% for part in parts %}
                        {% if part == 'to' %}
                            {% set to_index.value = loop.index0 %}
                        {% endif %}
                    {% endfor %}
                    {% if to_index.value != -1 %}
                        {% set timestamp_start = parts[to_index.value - 1] | replace('-', ':') | regex_replace('\\.[0-9]{3}$', '') if to_index.value > 0 else '' %}
                        {% set timestamp_end = parts[to_index.value + 1] | replace('-', ':') | regex_replace('\\.[0-9]{3}$', '') if to_index.value + 1 < parts | length else '' %}
                        {% set last_part = parts | last %}
                        {% set resolution = last_part %}
                        {% set padding = '' %}
                        {% if last_part | regex_match('^\\d+x\\d+p\\d+(\\.\\d+)?$') %}
                            {% set res_parts = last_part | split('p') %}
                            {% if res_parts | length == 2 %}
                                {% set resolution = res_parts[0] %}
                                {% set padding = res_parts[1] %}
                            {% endif %}
                        {% endif %}
                        {% set movie_parts = parts[0:to_index.value - 1] if to_index.value > 1 else [] %}
                    {% else %}
                        {% set movie_parts = parts %}
                    {% endif %}
                    {% set movie_name = movie_parts | join(' ') | default('Unnamed Clip', true) %}
                    {% set timestamp = timestamp_start ~ ' - ' ~ timestamp_end if timestamp_start and timestamp_end else '' %}
                    {% set filetype = basename | splitext | last | replace('.', '') | upper %}
                    <li class="p-3 rounded-md hover:bg-gray-200 cursor-pointer dark:hover:bg-gray-700 flex items-center justify-between w-full min-w-[250px]" style="display: flex; justify-content: space-between;">
                        <div class="flex flex-col pr-4 w-full">
                            <a href="{{ url_for('preview', history_file=full_path) }}" class="text-gray-900 dark:text-gray-200 font-semibold mb-2">{{ movie_name }}</a>
                            <div class="flex flex-wrap gap-1">
                                {% if timestamp %}
                                <span class="text-xs text-gray-900 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">{{ timestamp }}</span>
                                {% endif %}
                                {% if resolution %}
                                <span class="text-xs text-gray-900 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">{{ resolution }}</span>
                                {% endif %}
                                {% if padding %}
                                <span class="text-xs text-gray-900 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">Pad: {{ padding }}s</span>
                                {% endif %}
                                {% if filetype %}
                                <span class="text-xs text-gray-900 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">{{ filetype }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            {% if s3_enabled %}
                            <div class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-400 transition-colors flex items-center space-x-2">
                                <i class="fas fa-share-alt cursor-pointer" onclick="shareFile('{{ full_path | replace('/output/', '') }}', '{{ basename }}')"></i>
                            </div>
                            {% else %}
                            <div class="bg-gray-300 text-white py-2 px-4 rounded-lg cursor-not-allowed dark:bg-gray-600 pointer-events-none flex items-center space-x-2" title="Sharing is disabled because S3 is not configured">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            {% endif %}
                            <div class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-400 transition-colors flex items-center space-x-2">
                                <i class="fas fa-trash cursor-pointer" onclick="deleteFile('{{ full_path }}')"></i>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-red-900 text-base opacity-100 bg-red-200 dark:bg-red-900 dark:text-red-300 px-2 py-1 rounded text-center">No history available</div>
        {% endif %}
    </div>
    <div class="flex justify-center mt-4">
        <button class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-400 transition-colors" onclick="clearAllClips()">Clear All Clips</button>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/themeToggle.js') }}"></script>
<script>
    function filterHistory() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('ul li');
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = searchTerm && !text.includes(searchTerm) ? 'none' : '';
        });
    }

    function deleteFile(filePath) {
        console.log('Deleting file:', filePath);
        fetch('/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'file_path=' + encodeURIComponent(filePath)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Delete response:', data);
            if (data.success) {
                const item = document.querySelector(`li i[onclick="deleteFile('${filePath}')"]`).parentElement.parentElement.parentElement;
                if (item) item.remove();
            } else {
                alert('Failed to delete file: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error during delete fetch:', error);
            alert('An error occurred while deleting the file.');
        });
    }

    function clearAllClips() {
        if (confirm('Are you sure you want to delete all clips? This action cannot be undone.')) {
            fetch('/clear_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Clear all response:', data);
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to clear all clips: ' + (data.message || 'Unknown error'));
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error during clear all fetch:', error);
                alert('An error occurred while clearing all clips.');
            });
        }
    }

    function shareFile(filePath, basename) {
    const parts = basename.split('_');
    let movieName = '';
    for (let i = 0; i < parts.length; i++) {
        if (/\d{2}-\d{2}-\d{2}\.\d{3}/.test(parts[i])) {
            break;
        }
        movieName += (i > 0 ? ' ' : '') + parts[i].replace(/_/g, ' ');
    }
    movieName = movieName || 'Video Clip';
    const text = "Check out this video clip from Jclipper!";
    {% if s3_enabled %}
    fetch('/upload_s3?file=' + encodeURIComponent(filePath))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (navigator.share) {
                    navigator.share({
                        title: movieName,
                        text: text,
                        url: data.url
                    }).then(() => {
                        console.log('Shared successfully');
                    }).catch(err => {
                        console.error('Share failed:', err);
                        navigator.clipboard.writeText(data.url).then(() => {
                            alert('Share not supported. Video link copied to clipboard!');
                        }).catch(err => {
                            console.error('Failed to copy:', err);
                            alert('Share not supported and failed to copy video link.');
                        });
                    });
                } else {
                    navigator.clipboard.writeText(data.url).then(() => {
                        alert('Share not supported. Video link copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        alert('Share not supported and failed to copy video link.');
                    });
                }
            } else {
                alert('S3 upload failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error('S3 upload error:', error);
            alert('S3 upload failed.');
        });
    {% else %}
    alert('Sharing is not available because S3 is not configured.');
    {% endif %}
}

    window.addEventListener('load', () => {
        filterHistory();
    });
</script>
{% endblock %}