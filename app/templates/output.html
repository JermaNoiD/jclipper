{% extends 'base.html' %}
{% block title %}Jclipper - Output{% endblock %}
{% block content %}
<div class="container mx-auto mt-8 px-4 flex-grow">
    <div class="bg-white rounded-lg border border-gray-300 p-4 max-w-3xl mx-auto min-h-[200px] overflow-y-auto no-scrollbar dark:bg-gray-800 dark:border-gray-700 transition-colors">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-200 mb-4">Output Settings</h2>
        <form method="POST" action="{{ url_for('generate') }}" class="space-y-4" id="generate-form">
            <input type="hidden" name="start" value="{{ start }}">
            <input type="hidden" name="end" value="{{ end }}">
            <input type="hidden" name="video" value="{{ video }}">
            <input type="hidden" name="resolution" value="{{ original_res[0] }}x{{ original_res[1] }}">
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label class="text-gray-700 dark:text-gray-300 font-medium w-full sm:w-1/3">Padding (seconds):</label>
                <div class="w-full sm:w-2/3 flex items-center space-x-2">
                    <input type="range" step="0.1" min="0" max="10" name="padding" value="{{ padding if padding else '0' }}" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500 transition-colors">
                    <span class="text-gray-700 dark:text-gray-300 min-w-[80px]"><span id="padding-value">{{ padding if padding else '0' }}</span> seconds</span>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label class="text-gray-700 dark:text-gray-300 font-medium w-full sm:w-1/3">Scale Factor: (Original: {{ original_res[0] }}x{{ original_res[1] }})</label>
                <div class="w-full sm:w-2/3 flex items-center space-x-2">
                    <input type="range" step="0.1" min="0.1" max="1.0" name="scale_factor" value="{{ session.get('scale_factor', 1.0) }}" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500 transition-colors">
                    <span class="text-gray-700 dark:text-gray-300 min-w-[120px]">Scaled: <span id="scaled-resolution">{{ original_res[0] }}x{{ original_res[1] }}</span></span>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label class="text-gray-700 dark:text-gray-300 font-medium w-full sm:w-1/3">Format:</label>
                <select name="format" class="w-full sm:w-2/3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500 transition-colors">
                    {% for fmt in available_formats %}
                    <option value="{{ fmt }}" {% if fmt == default_format %}selected{% endif %}>{{ fmt.upper() }}</option>
                    {% endfor %}
                </select>
                <span class="text-gray-700 dark:text-gray-300 ml-2">Source: {{ source_format.upper() if source_format else 'N/A' }}</span>
            </div>
            {% if has_multiple_audio %}
            <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-4">
                <label class="text-gray-700 dark:text-gray-300 font-medium w-full sm:w-1/3">Audio Stream:</label>
                <div class="w-full sm:w-2/3 space-y-2">
                    {% for stream in audio_streams %}
                    <label class="flex items-center space-x-2 text-gray-900 dark:text-gray-200">
                        <input type="radio" name="audio_index" value="{{ stream.nth }}" {% if stream.nth == audio_index|default(0)|int %}checked{% endif %} class="text-gray-900 dark:text-gray-200 focus:ring-gray-400 dark:focus:ring-gray-500">
                        <span>{{ stream.lang }} ({{ stream.codec }}, {{ stream.channels }} channels)</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </form>
    </div>
    <div class="mt-4 flex justify-center space-x-4 max-w-3xl mx-auto">
        <a href="{{ url_for('subtitles', movie=video) }}" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors   flex items-center" title="Back to Subtitles">
            <i class="fas fa-arrow-left"></i>
        </a>
        <button type="submit" form="generate-form" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 dark:bg-green-400 dark:hover:bg-green-300 transition-colors flex items-center" title="Generate Clip">
            <i class="fas fa-check-circle"></i>
        </button>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/themeToggle.js') }}"></script>
<script>
    document.querySelector('form').id = 'generate-form';
    
    // Update padding value dynamically
    const paddingInput = document.querySelector('input[name="padding"]');
    const paddingSpan = document.getElementById('padding-value');
    paddingInput.addEventListener('input', function() {
        paddingSpan.textContent = this.value;
    });
    
    // Update scaled resolution dynamically
    const scaleInput = document.querySelector('input[name="scale_factor"]');
    const scaledSpan = document.getElementById('scaled-resolution');
    function updateResolution() {
        fetch(`/resolution?scale=${scaleInput.value}`)
            .then(response => response.json())
            .then(data => {
                scaledSpan.textContent = data.scaled;
            });
    }
    scaleInput.addEventListener('input', updateResolution);
    // Initialize resolution on page load
    updateResolution();
</script>
{% endblock %}