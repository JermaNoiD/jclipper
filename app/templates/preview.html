{% extends 'base.html' %}
{% block title %}Jclipper - Preview{% endblock %}
{% block content %}
<div class="container mx-auto mt-8 px-4 flex-grow">
    <div id="previewContainer" class="bg-white rounded-lg border border-gray-300 p-4 max-w-3xl mx-auto min-h-[200px] max-h-[60vh] overflow-y-auto no-scrollbar dark:bg-gray-800 dark:border-gray-700 transition-colors duration-300 flex flex-col items-center {% if main_status == 'encoding' %}pulse-animation{% endif %}">
        <div id="failure-msg" class="text-red-500 dark:text-red-400 text-center mb-4" style="display: {% if main_status == 'failure' %}block{% else %}none{% endif %} ;">
            Main encoding failed. Check FFmpeg output below for details.
        </div>
        {% set file_to_serve = output if main_status == 'success' else file %}
        {% set mime_type = 'video/mp4' if format == 'mp4' else 'video/x-matroska' if format == 'mkv' else 'video/x-msvideo' if format == 'avi' else 'audio/mpeg' %}
        {% set preview_mime = 'video/mp4' if format != 'mp3' else 'audio/mpeg' %}
        {% set is_audio = format == 'mp3' and main_status == 'success' %}
        {% if not is_audio %}
        <video class="preview-video rounded-lg mx-auto" controls style="max-width: 100%;" onerror="this.style.display='none'; document.getElementById('video-error').style.display='block';">
            <source src="{{ url_for('serve', file=file_to_serve) }}" type="{{ mime_type if main_status == 'success' else preview_mime }}">
            Your browser does not support the video tag.
        </video>
        {% else %}
        <audio class="preview-video" controls style="max-width: 100%;">
            <source src="{{ url_for('serve', file=file_to_serve) }}" type="{{ mime_type }}">
            Your browser does not support the audio tag.
        </audio>
        {% endif %}
        <div id="video-error" style="display: none; color: red; text-align: center;">
            Failed to load media. Try downloading or using a different format.
        </div>
        {% if not from_history %}
        <div class="mt-4 w-full flex items-center space-x-2">
            <button class="flex-grow bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors duration-300" onclick="document.getElementById('ffmpeg-output').classList.toggle('hidden')">
                Toggle FFmpeg Output
            </button>
            <div id="status-icon" class="icon-container bg-gray-200 dark:bg-gray-700">
                <i class="fas fa-sync-alt fa-spin text-blue-500 {% if main_status != 'encoding' %}hidden{% endif %}" title="Encoding in progress"></i>
                <i class="fas fa-check-circle text-green-500 {% if main_status != 'success' %}hidden{% endif %}" title="Encoding complete"></i>
            </div>
        </div>
        <div id="ffmpeg-output" class="hidden mt-2 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
            <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{% if main_ffmpeg_output %}{{ main_ffmpeg_output }}{% else %}FFmpeg output not available yet.{% endif %}</pre>
        </div>
        {% endif %}
        <div class="mt-4 flex justify-center space-x-4">
            <button id="download-btn" onclick="window.location.href='{{ url_for('download') }}'" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-400 transition-colors duration-300 flex items-center space-x-2 {% if main_status != 'success' %}bg-gray-300 cursor-not-allowed dark:bg-gray-600 pointer-events-none{% endif %}" {% if main_status != 'success' %}disabled{% endif %}>
                <i class="fas fa-download"></i>
                <span>Download</span>
            </button>
            {% if s3_enabled %}
            <button id="share-btn" onclick="shareVideo()" class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-400 transition-colors duration-300 flex items-center space-x-2 {% if main_status != 'success' %}bg-gray-300 cursor-not-allowed dark:bg-gray-600 pointer-events-none{% endif %}" {% if main_status != 'success' %}disabled{% endif %}>
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
            </button>
            {% else %}
            <button id="share-btn" class="bg-gray-300 text-white py-2 px-4 rounded-lg cursor-not-allowed dark:bg-gray-600 pointer-events-none flex items-center space-x-2" disabled title="Sharing is disabled because S3 is not configured">
                <i class="fas fa-share-alt"></i>
                <span>Share</span>
            </button>
            {% endif %}
            {% if not from_history %}
            <a href="{{ url_for('cancel_encoding') }}?next=output" onclick="return confirm('Cancel encoding and modify?');" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-400 transition-colors duration-300 flex items-center space-x-2">Modify</a>
            <a href="{{ url_for('cancel_encoding') }}?next=index" onclick="return confirm('Cancel encoding and return to home?');" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-400 transition-colors duration-300">Cancel</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/themeToggle.js') }}"></script>
<script>
    function uploadToS3() {
        fetch('/upload_s3')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    navigator.clipboard.writeText(data.url).then(() => {
                        alert('Video uploaded to S3 and video link copied to clipboard! Works in Discord; may not show a preview in Facebook Messenger.');
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Video uploaded to S3 but failed to copy video link.');
                    });
                } else {
                    alert('S3 upload failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('S3 upload error:', error);
                alert('S3 upload failed.');
            });
    }

    function shareVideo() {
        const title = "{{ movie_name | default('Video Clip') }}";
        const text = "Check out this video clip from Jclipper!";
        {% if s3_enabled %}
        fetch('/upload_s3{% if from_history %}?file={{ output | urlencode }}{% endif %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (navigator.share) {
                        navigator.share({
                            title: title,
                            text: text,
                            url: data.url
                        }).then(() => {
                            console.log('Shared successfully');
                        }).catch(err => {
                            console.error('Share failed:', err);
                            // Fallback to clipboard
                            navigator.clipboard.writeText(data.url).then(() => {
                                alert('Share not supported. Video link copied to clipboard!');
                            }).catch(err => {
                                console.error('Failed to copy:', err);
                                alert('Share not supported and failed to copy video link.');
                            });
                        });
                    } else {
                        // Fallback for non-supported browsers
                        navigator.clipboard.writeText(data.url).then(() => {
                            alert('Share not supported. Video link copied to clipboard!');
                        }).catch(err => {
                            console.error('Failed to copy:', err);
                            alert('Share not supported and failed to copy video link.');
                        });
                    }
                } else {
                    alert('S3 upload failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('S3 upload error:', error);
                alert('S3 upload failed.');
            });
        {% else %}
        alert('Sharing is not available because S3 is not configured.');
        {% endif %}
    }

    function updateStatus() {
        {% if not from_history %}
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                const status = data.status;
                const output = data.ffmpeg_output;
                // Update failure msg
                const failureDiv = document.getElementById('failure-msg');
                failureDiv.style.display = (status === 'failure') ? 'block' : 'none';
                // Update ffmpeg output
                const pre = document.querySelector('#ffmpeg-output pre');
                pre.textContent = output || 'FFmpeg output not available yet.';
                // Update pulse
                const container = document.getElementById('previewContainer');
                if (status === 'encoding') {
                    container.classList.add('pulse-animation');
                } else {
                    container.classList.remove('pulse-animation');
                }
                // Update buttons
                const downloadBtn = document.getElementById('download-btn');
                const shareBtn = document.getElementById('share-btn');
                if (status === 'success') {
                    downloadBtn.classList.remove('bg-gray-300', 'cursor-not-allowed', 'dark:bg-gray-600', 'pointer-events-none');
                    downloadBtn.classList.add('bg-blue-500', 'hover:bg-blue-400');
                    downloadBtn.removeAttribute('disabled');
                    shareBtn.classList.remove('bg-gray-300', 'cursor-not-allowed', 'dark:bg-gray-600', 'pointer-events-none');
                    shareBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
                    shareBtn.removeAttribute('disabled');
                } else {
                    downloadBtn.classList.add('bg-gray-300', 'cursor-not-allowed', 'dark:bg-gray-600', 'pointer-events-none');
                    downloadBtn.classList.remove('bg-blue-500', 'hover:bg-blue-400');
                    downloadBtn.setAttribute('disabled', 'disabled');
                    shareBtn.classList.add('bg-gray-300', 'cursor-not-allowed', 'dark:bg-gray-600', 'pointer-events-none');
                    shareBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
                    shareBtn.setAttribute('disabled', 'disabled');
                }
                // Update status icon
                const refreshIcon = document.querySelector('#status-icon .fa-sync-alt');
                const successIcon = document.querySelector('#status-icon .fa-check-circle');
                if (status === 'encoding') {
                    refreshIcon.classList.remove('hidden');
                    successIcon.classList.add('hidden');
                } else if (status === 'success') {
                    refreshIcon.classList.add('hidden');
                    successIcon.classList.remove('hidden');
                } else {
                    refreshIcon.classList.add('hidden');
                    successIcon.classList.add('hidden');
                }
                // Continue polling if encoding
                if (status === 'encoding') {
                    setTimeout(updateStatus, 5000);
                }
            })
            .catch(error => console.error('Status poll error:', error));
        {% endif %}
    }
    window.onload = function() {
        updateStatus();
    };
</script>
{% endblock %}