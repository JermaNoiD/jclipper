{% extends 'base.html' %}
{% block title %}Jclipper - Preview{% endblock %}
{% block content %}
<div class="container mx-auto mt-8 px-4 flex-grow">
    <h1 class="text-xl font-bold text-gray-900 dark:text-gray-200 flex justify-center sticky top-0 bg-white dark:bg-gray-800 z-10 p-0 w-100% border-t border-l border-r rounded-t-lg border-gray-300 dark:border-gray-700 max-w-3xl mx-auto transition-colors">{{ movie_name }}</h1>
    <div id="previewContainer" class="bg-white rounded-b-lg border border-gray-300 p-4 max-w-3xl mx-auto min-h-[200px] max-h-[60vh] overflow-y-auto no-scrollbar dark:bg-gray-800 dark:border-gray-700 transition-colors flex flex-col items-center">
        {% if main_status == 'failure' %}
        <div class="text-red-500 dark:text-red-400 text-center mb-4">
            Encoding failed. Check the FFmpeg output below for details.
        </div>
        {% endif %}
        {% set mime_type = 'video/mp4' if format == 'mp4' else 'image/gif' if format == 'gif' else 'audio/mpeg' if format == 'mp3' else '' %}
        {% set is_audio = format == 'mp3' %}
        {% set is_image = format == 'gif' %}
        {% set is_video = not is_audio and not is_image %}
        {% if main_status == 'success' %}
            {% if is_video %}
            <video class="preview-video rounded-lg mx-auto" controls crossorigin="anonymous" playsinline style="max-width: 100%;" onerror="this.style.display='none'; document.getElementById('video-error').style.display='block';">
                <source src="{{ url_for('serve', file=output) }}" type="{{ mime_type }}">
                Your browser does not support the video tag.
            </video>
            {% elif is_audio %}
            <audio class="preview-video" controls crossorigin="anonymous" style="max-width: 100%;">
                <source src="{{ url_for('serve', file=output) }}" type="{{ mime_type }}">
                Your browser does not support the audio tag.
            </audio>
            {% elif is_image %}
            <img src="{{ url_for('serve', file=output) }}" class="preview-video rounded-lg mx-auto" style="max-width: 100%;" onerror="this.style.display='none'; document.getElementById('video-error').style.display='block';">
            {% endif %}
        {% endif %}
        <div id="video-error" style="display: none; color: red; text-align: center;">
            Failed to load media. Try downloading or using a different format.
        </div>
        <div class="mt-4 flex justify-center space-x-4">
            {% if from_history %}
            <a href="{{ url_for('history') }}" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center" title="Back to History">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% else %}
            <a href="{{ url_for('home') }}" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center" title="Home">
                <i class="fas fa-home"></i>
            </a>
            {% endif %}
            <button id="download-btn" onclick="window.location.href='{{ url_for('download') }}'" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-400 transition-colors flex items-center {% if main_status != 'success' %}bg-gray-300 cursor-not-allowed dark:bg-gray-600 pointer-events-none{% endif %}" {% if main_status != 'success' %}disabled{% endif %} title="Download">
                <i class="fas fa-download"></i>
            </button>
            {% if s3_enabled %}
            <button id="share-btn" onclick="shareVideo()" class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-400 transition-colors flex items-center {% if main_status != 'success' %}bg-gray-300 cursor-not-allowed dark:bg-gray-600 pointer-events-none{% endif %}" {% if main_status != 'success' %}disabled{% endif %} title="Share">
                <i class="fas fa-share-alt"></i>
            </button>
            {% else %}
            <button id="share-btn" class="bg-gray-300 text-white py-2 px-4 rounded-lg cursor-not-allowed dark:bg-gray-600 pointer-events-none flex items-center" disabled title="Sharing is disabled because S3 is not configured">
                <i class="fas fa-share-alt"></i>
            </button>
            {% endif %}
            {% if from_history %}
            <button id="delete-btn" onclick="deleteFile('{{ output }}')" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-400 transition-colors flex items-center" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </div>
    {% if not from_history %}
    <div id="ffmpegContainer" class="bg-white rounded-lg border border-gray-300 p-4 max-w-3xl mx-auto mt-4 min-h-[100px] overflow-y-auto no-scrollbar dark:bg-gray-800 dark:border-gray-700 transition-colors flex flex-col items-center">
        <div class="w-full flex items-center space-x-2">
            <button class="flex-grow bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors" onclick="document.getElementById('ffmpeg-output').classList.toggle('hidden')" title="Toggle FFmpeg Output">
                <i class="fas fa-terminal"></i>
            </button>
            <div id="status-icon" class="icon-container bg-gray-200 dark:bg-gray-700">
                <i class="fas fa-check-circle text-green-500 {% if main_status != 'success' %}hidden{% endif %}" title="Encoding complete"></i>
            </div>
        </div>
        <div id="ffmpeg-output" class="hidden mt-2 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg w-full">
            <pre class="text-[8px] text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{% if main_ffmpeg_output %}{{ main_ffmpeg_output }}{% else %}FFmpeg output not available.{% endif %}</pre>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/themeToggle.js') }}"></script>
<script>
    function deleteFile(filePath) {
        if (confirm('Are you sure you want to delete this clip?')) {
            fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'file_path=' + encodeURIComponent(filePath)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ url_for('history') }}';
                } else {
                    alert('Failed to delete file: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error during delete fetch:', error);
                alert('An error occurred while deleting the file.');
            });
        }
    }

    function shareVideo() {
        const title = "{{ movie_name | default('Video Clip') }}";
        const text = "Check out this video clip from Jclipper!";
        {% if s3_enabled %}
        fetch('/upload_s3{% if from_history %}?file={{ output | urlencode }}{% endif %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (navigator.share) {
                        navigator.share({ title: title, text: text, url: data.url })
                            .catch(err => {
                                navigator.clipboard.writeText(data.url).then(() => {
                                    alert('Share not supported. Video link copied to clipboard!');
                                });
                            });
                    } else {
                        navigator.clipboard.writeText(data.url).then(() => {
                            alert('Share not supported. Video link copied to clipboard!');
                        });
                    }
                } else {
                    alert('S3 upload failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('S3 upload error:', error);
                alert('S3 upload failed.');
            });
        {% else %}
        alert('Sharing is not available because S3 is not configured.');
        {% endif %}
    }
</script>
{% endblock %}
